<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>paddle_and_ball</title>
    <style media="screen">
    canvas {
        border: 1px black solid;
    }
    </style>
</head>

<body>
    <canvas id="id-canvas" width="500" height="400"></canvas>
<script>
	// wrap console.log for convenience
    var log = console.log.bind(console)

    var imageFromPath = function(path){
    	var img = new Image()
    	img.src = path
    	return img
    }

    var Paddle = function() {
    	var image = imageFromPath('paddle.png')

    	var o = {
    		image: image,
    		speed: 10,
    		x: 100,
    		y: 320,
    		width: 200,
    		height: 30,
    	}

    	o.moveLeft = function() {
    		o.x -= o.speed
    	}

    	o.moveRight = function() {
    		o.x += o.speed
    	}

    	return o
    }

    var Ball = function() {
    	var image = imageFromPath('ball.png')
    	var canvas = document.querySelector('#id-canvas')

    	var o = {
    		image: image,
    		xSpeed: 10,
    		ySpeed: 10,
    		x:100,
    		y:320,
    		width: 30,
    		height: 30,
    		fired: false,
    		max_width: canvas.width,
    		max_height: canvas.height,
    	}

    	o.fire = function() {
    		o.fired = true
    	}

    	o.move = function() {

    		if (o.fired) {

	    		if (o.x + o.width >= o.max_width || o.x <= 0) {
	    			o.xSpeed *= -1
	    		} else if (o.y <= 0 || o.y + o.height >= o.max_height) {
	    			o.ySpeed *= -1
	    		}

	    		o.x += o.xSpeed
	    		o.y += o.ySpeed
    		}
    	}

    	o.collide = function(paddle) {
    		
    		if (o.y + o.height >= paddle.y && (o.x >= paddle.x && o.x <= paddle.x + paddle.width))
    			return true

    		return false
    	}

    	return o
    }

    var Game = function() {
    	var game = {
    		actions: {},
    		keydowns: {},
    	}

    	var canvas = document.querySelector("#id-canvas")
    	game.canvas = canvas

    	var context = canvas.getContext('2d')
    	game.context = context

    	game.drawImage = function(o) {
    		game.context.drawImage(o.image, o.x, o.y, o.width, o.height)
    	}	  	
  		
  		// events
  		window.addEventListener('keydown', (event) => {

    		game.keydowns[event.key] = true
    	})

    	window.addEventListener('keyup', (event) => {

    		game.keydowns[event.key] = false
    	})

    	game.registration = function(key, callback) {
    		game.actions[key] = callback
    	}

    	setInterval(function() {

    		var actions = Object.keys(game.actions)

    		for (var i = actions.length - 1; i >= 0; i--) {
    			     				
    			var key = actions[i]
  
    			if (game.keydowns[key]) {
    				// when the key is pressed, call its action
    				game.actions[key]()
    			}
    		}

    		game.update()
    		context.clearRect(0, 0, canvas.width, canvas.height)
			game.draw()

    	}, 1000/30)

    	return game
    }

    var __main = function() {
    	var game = Game()

		var paddle = Paddle()
    	var ball = Ball()

    	game.registration('a', function() {
    		paddle.moveLeft()
    	})

		game.registration('d', function() {
    		paddle.moveRight()
    	})    	

    	game.registration('b', function() {
    		ball.fire()
    	})

    	game.update = function() {
    		ball.move()

    		if (ball.collide(paddle)) {
    			ball.ySpeed *= -1
    		}
    	}
		
		// draw the paddle and the ball
		game.draw = function() {
			game.drawImage(paddle)
			game.drawImage(ball)
		}
    }

    __main()
    
</script>
</body>

</html>